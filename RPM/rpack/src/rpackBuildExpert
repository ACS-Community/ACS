#!/bin/sh

NO_ARGS=0
E_OPTERROR=65

if [ $# -eq "$NO_ARGS" ]  # Script invoked with no command-line args?
then
  echo "Usage: `basename $0` -h | -n <Package Name> -p <> -s i<> -b <> -i <> -d <> -m <>"
  exit $E_OPTERROR        # Exit and explain usage, if no argument(s) given.
fi

ACS_PACKAGE_NAME=""
ACS_PACKAGE_PNAME=""
ACS_PACKAGE_SUMMARY=""
ACS_PACKAGE_DEPENDENCIES=""
ACS_PACKAGE_REQUIREMENTS=""
ACS_PACKAGE_DESCRIPTION=""
ACS_PACKAGE_MODULES=""

ACS_SOURCES_DIR=".."
RPM_SCRIPTS_DIR="rpack/config/templates"
RPM_SPECS_DIR="./RPM_SPECS"
RPM_SOURCES_DIR="./RPM_SOURCES"
RPM_SPECS_TEMPLATE=""
RPM_COMPILE_FARM=""

# Check if directories exist
if [ ! -d $RPM_SPECS_DIR ]
then
	mkdir $RPM_SPECS_DIR
fi

if [ ! -d $RPM_SOURCES_DIR ]
then
	mkdir $RPM_SOURCES_DIR
fi

while getopts ":hn:p:s:b:i:d:m:a:c:" Option
do
  case $Option in
    h     ) echo "HELP!!!!!"; exit 0;;
    n     ) ACS_PACKAGE_NAME=$OPTARG;;
    p     ) ACS_PACKAGE_PNAME=$OPTARG;;
    s     ) ACS_PACKAGE_SUMMARY=$OPTARG;;
    b     ) ACS_PACKAGE_DEPENDENCIES="$ACS_PACKAGE_DEPENDENCIES $OPTARG";;
    i     ) ACS_PACKAGE_REQUIREMENTS="$ACS_PACKAGE_REQUIREMENTS $OPTARG";;
    d     ) ACS_PACKAGE_DESCRIPTION=$OPTARG;;
    m     ) ACS_PACKAGE_MODULES="$ACS_PACKAGE_MODULES $OPTARG";;
    a     ) ACS_SOURCES_DIR=$OPTARG;;
    c     ) RPM_COMPILE_FARM=$OPTARG;;
    *     ) echo "Invalid Option or missing parameter"; exit 1;;   # DEFAULT
  esac
done

case  $ACS_PACKAGE_NAME in
	"AcsDevelKit") RPM_SPECS_TEMPLATE="rpackTemplate-AcsDevelKit";;
	"AcsExtProd")  RPM_SPECS_TEMPLATE="rpackTemplate-AcsExtProd";;
	"AcsSW")       RPM_SPECS_TEMPLATE="rpackTemplate-AcsSW";;
         *)            echo "Invalid Package Name"; exit 1 ;;
esac

case X"$ACS_PACKAGE_PNAME" in
	"X") ACS_PACKAGE_FNAME=$ACS_PACKAGE_NAME;;
	*)   ACS_PACKAGE_FNAME=$ACS_PACKAGE_NAME-$ACS_PACKAGE_PNAME;;
esac

#Building spec file from spec Template
# Generating sed script
ACS_VERSION=`cat $ACS_SOURCES_DIR/ACS_VERSION`
ACS_RELEASE=`cat $ACS_SOURCES_DIR/ACS_PATCH_LEVEL`
echo "s/ACS_VERSION/$ACS_VERSION/" > $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "s/ACS_RELEASE/$ACS_RELEASE/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "s/ACS_PACKAGE_NAME/$ACS_PACKAGE_FNAME/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "s/ACS_PACKAGE_PNAME/$ACS_PACKAGE_PNAME/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "s/ACS_PACKAGE_SUMMARY/$ACS_PACKAGE_SUMMARY/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n "s/ACS_PACKAGE_DEPENDENCIES/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n $ACS_PACKAGE_DEPENDENCIES >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n "s/ACS_PACKAGE_REQUIREMENTS/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n $ACS_PACKAGE_REQUIREMENTS >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "s/ACS_PACKAGE_DESCRIPTION/$ACS_PACKAGE_DESCRIPTION/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n "s/ACS_PACKAGE_MODULES/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n "\\\"" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n $ACS_PACKAGE_MODULES | sed '{s/\//\\\//g}' >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo -n "\\\"" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed
echo "/" >> $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed

#Generating spec file from sed script and Template.spec
echo "# Generated by buildSpec" > $RPM_SPECS_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.spec

sed -f $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed $RPM_SCRIPTS_DIR/$RPM_SPECS_TEMPLATE.spec >> $RPM_SPECS_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.spec
rm -f  $RPM_SCRIPTS_DIR/$ACS_PACKAGE_FNAME.sed

#Partitioning sources file from ACS Sources
if [ -f $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.tar.gz ]
then
	rm -f $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.tar.gz
fi

if [ -d $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION ]
then
	rm -rf  $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION
fi

mkdir $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION

(cd $ACS_SOURCES_DIR; tar cf - Makefile LGPL/acsBUILD $ACS_PACKAGE_MODULES) | ( cd $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION ; tar xf - )

# Patching the .bash_profile.acs for AcsDevelKit
if [ X$ACS_PACKAGE_NAME = XAcsDevelKit ]
then
	cd $RPM_SOURCES_DIR/$ACS_PACKAGE_NAME-$ACS_VERSION
	sed 's/ALMASW_ROOTDIR=\/alma/ALMASW_ROOTDIR=$RPM_BUILD_ROOT\/alma/' LGPL/acsBUILD/config/.acs/.bash_profile.acs > LGPL/acsBUILD/config/.acs/.bash_profile.acs.rpm
	mv LGPL/acsBUILD/config/.acs/.bash_profile.acs.rpm LGPL/acsBUILD/config/.acs/.bash_profile.acs
	cd ../..
fi

cd $RPM_SOURCES_DIR; tar czf $ACS_PACKAGE_FNAME-$ACS_VERSION.tar.gz $ACS_PACKAGE_FNAME-$ACS_VERSION; cd ..
rm -rf $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION

# cp the tar and spec files to the correct directories if compile farm is defined
if [ X$RPM_COMPILE_FARM != X ]
then
	if [ -d $RPM_COMPILE_FARM ]
	then
		# TBD Check directory structure
		cp $RPM_SPECS_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.spec $RPM_COMPILE_FARM/SPECS
		cp $RPM_SOURCES_DIR/$ACS_PACKAGE_FNAME-$ACS_VERSION.tar.gz $RPM_COMPILE_FARM/SOURCES
	fi
fi
