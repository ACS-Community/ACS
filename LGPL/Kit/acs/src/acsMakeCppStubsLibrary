#! /bin/bash
#*******************************************************************************
# E.S.O. - ALMA project
#
# "@(#) $Id: acsMakeCppStubsLibrary,v 1.7 2007/02/28 07:13:01 mzampare Exp $" 
#
idlName=$1
idlNameLIBS=$2
makeDir=$3
vxWorks=$4

FILE=/tmp/IdlCppStubsGeneration$$_$USER
FILE2=/tmp/IdlCppStubsSubMake$$
libName="${idlName}Stubs"
if [ -f ../object/${idlName}C.cpp -a  -f ../object/${idlName}S.cpp ]
then
# adding the Hack required by Gianluca, we generate a library:
	echo "# Dependency file for library: ${libName}" > $FILE
	echo "# DO NOT EDIT THIS FILE" >> $FILE
	echo "MAKEDIR=${makeDir}" >> $FILE
	echo "IDL_FILES=${idlName}" >> $FILE
	echo "include ${makeDir}/acsMakefile" >> $FILE
	if [  "xx$vxWorks" != "xx" ]
	    then
	    echo "../object/${libName}.dx:" >> $FILE
	    echo "	-vltMakeExecutableDependencies /vw $libName \"${idlName}S ${idlName}C\" \"\" \"\" \"\" > ../object/${libName}.dx" >> $FILE
	    echo "include ../object/${libName}.dx" >> $FILE
	else   
	    echo "../object/${libName}.da:" >> $FILE
	    echo "	-vltMakeLibraryDependencies $libName \"${idlName}S ${idlName}C\" \"\" \"\" \"${idlNameLIBS}\" > ../object/${libName}.da" >> $FILE
	    echo "vpath %.so \$(subst -L,:,\$(L_PATH)) " >> $FILE
	    echo "include ../object/${libName}.da" >> $FILE
	fi
	echo "" >> $FILE
	make -s -f $FILE $libName   > $FILE2 2>&1
	if [ $? != 0 ]  
	then 
	    cat $FILE2
	    rm  $FILE2
	    exit -1
	fi
	rm  $FILE2
	rm $FILE
	rm -f ../object/${libName}.da ../object/${libName}.dx
else 
    echo "** ERROR: IDL Compilation must have failed before, nothing to do";
    exit -1
fi
