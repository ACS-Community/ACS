#! /bin/bash
. acsstartupAcsPorts
. acsstartupAcsInstance
. acsstartupLogging.sh
. acsstartupConstants
#*******************************************************************************
# E.S.O. - VLT project
#
# "@(#) $Id: acsStartORBSRVC,v 1.61 2006/06/20 21:49:59 dfugate Exp $"
#
# who       when      what
# --------  --------  ----------------------------------------------
# sharring 2004-06-23 restructured for performance
# mschilli 2004-04-16 added proper command line parsing
# gchiozzi 2003-06-04 Fixed usage of ORBOPTS="-ORBDottedDecimalAddresses 1"
# david 2003-05-14 changed to bash for tat tests
# gchiozzi 2003-04-02 Replaced nsadd in $PATH with standard $ACE_ROOT one
# gchiozzi 2002-11-22 Added starting CDB
# gchiozzi 2002-09-30 Removed CDB Server. Not needed any more.
# bjeram 2002-04-10 added -silent options for acsLogSvc
# bjeram 2002-04-10 added acslogsvc
# almamgr 2001-11-23 Changed handling of IOR file for IR
# gchiozzi 2001-11-16 Added acsIrfeed
# almamgr 2001-09-20 Remove export. Did not work on Sun
# gchiozzi 2001-09-20 Added loading of ACS IDLs in interface repository
# gchiozzi 2001-09-19 created
#

#************************************************************************
#   NAME
# 
#   SYNOPSIS
# 
#   DESCRIPTION
#
#   FILES
#
#   ENVIRONMENT
#
#   RETURN VALUES
#
#   CAUTIONS
#
#   EXAMPLES
#
#   SEE ALSO
#
#   BUGS     
#
#------------------------------------------------------------------------
#

ACS_LOG_COMMAND $@

PID=$$
export HOST=`getIP`

###
### ----------- Command Line Parsing ---------------------

#
# These will contain the parsing results (CL_XXX, CL = command line)
#
CL_BASEPORT=
CL_HELP=

#
# These options can be recognized (longopts comma-separated. colon means argument is required)
#
LONGOPTS=help,baseport:,timeout:
SHORTOPTS=hb:t:

#
# Usage info. Be nice and keep this up-to-date!
#
function printUsage {
   echo "Starts Orb services for Acs; note that acsStart is an alternative for this"
   echo ""
	echo "Usage: `basename $0` [OPTIONS]  "
	echo "Options: "
	echo "   -b | -baseport INSTANCE        the acs instance (0-9) you want to use"
	echo "   -t | -timeout MULTIPLIER       the maximum timeout can be increased by specifying an integer value greater than 1"
	echo "   -h | -help                     prints this help and exits"
}

#
# Run getopt (posixly_correct needed). We run twice:
# First run is simply to check the commandline for correctness
# Second run is the real deal which replaces the command line args with getopt's output
export POSIXLY_CORRECT=1

getopt -n `basename $0` -Q -u -a -l $LONGOPTS $SHORTOPTS "$@" || {
   printUsage
	exit $EC_BADARGS;
}

set -- `getopt -u -a -l $LONGOPTS $SHORTOPTS "$@"`

#
# Iterate over getopt's output and set CL_XXX variables accordingly
#
while : 
do
	case "$1" in
	--baseport)         CL_BASEPORT=$2 ; shift ;;
	-b)                 CL_BASEPORT=$2 ; shift ;;
	--timeout)          export ACS_STARTUP_TIMEOUT_MULTIPLIER=$2 ; shift ;;
	-t)                 export ACS_STARTUP_TIMEOUT_MULTIPLIER=$2 ; shift ;;
	--help)             CL_HELP=true ;; 
	-h)                 CL_HELP=true ;; 
	--) break ;;
	esac
	shift
done
shift

# restore 
export POSIXLY_CORRECT=
unset POSIXLY_CORRECT


if [ "$CL_HELP" ] ; then
   printUsage
   exit $EC_OK
fi


#
# (Note: Rest of command line now in $@ )
#
### ---------- End of Command Line Parsing -------------


################################
#Set variables
################################

#Check command-line args for baseport option
if [ "$CL_BASEPORT" ]
then
    export ACS_INSTANCE="$CL_BASEPORT"
fi

#Makes shure there is an initial value
if [ X"$ACS_STARTUP_TIMEOUT_MULTIPLIER" = X ]
 then
   ACS_STARTUP_TIMEOUT_MULTIPLIER=5
fi

#maximum timeout for any given process to complete
MAX_TIMEOUT=$(( 10 * $ACS_STARTUP_TIMEOUT_MULTIPLIER ))

export STD_SLEEP=3

export INSTANCE_DIR=`getInstanceDirName $ACS_INSTANCE`

#use the instance directory to get the complete names of the 
#files where process IDs are stored in.
IR_PIDFILE=$INSTANCE_DIR/$ACS_IR_PIDFILE
NAMING_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_NAMING_SERVICE_PIDFILE
NOTIFY_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_NOTIFY_SERVICE_PIDFILE
LOGGING_NOTIFY_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_LOGGING_NOTIFY_SERVICE_PIDFILE
ARCHIVE_NOTIFY_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_ARCHIVE_NOTIFY_SERVICE_PIDFILE
LOGGING_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_LOGGING_SERVICE_PIDFILE
LOG_SERVICE_PIDFILE=$INSTANCE_DIR/$ACS_LOG_SERVICE_PIDFILE
IRFEED_PIDFILE=$INSTANCE_DIR/$ACS_IRFEED_PIDFILE

#set the filenames where binaries' output will be sent
NOTIFY_OUT=$INSTANCE_DIR/$ACS_NOTIFY_OUT
LOG_NOTIFY_OUT=$INSTANCE_DIR/$ACS_LOG_NOTIFY_OUT
ARCHIVE_NOTIFY_OUT=$INSTANCE_DIR/$ACS_ARCHIVE_NOTIFY_OUT
LOG_SERVICE_OUT=$INSTANCE_DIR/$ACS_LOG_SERVICE_OUT
CDB_OUT=$INSTANCE_DIR/$ACS_CDB_OUT
LOGGING_OUT=$INSTANCE_DIR/$ACS_LOGGING_OUT

#IOR locations
NAME_IOR=$INSTANCE_DIR/$ACS_NAMING_SERVICE_IORFILE
NOTIFY_IOR=$INSTANCE_DIR/$ACS_NOTIFY_SERVICE_IORFILE
LOGGING_NOTIFY_IOR=$INSTANCE_DIR/$ACS_LOGGING_NOTIFY_SERVICE_IORFILE
ARCHIVE_NOTIFY_IOR=$INSTANCE_DIR/$ACS_ARCHIVE_NOTIFY_SERVICE_IORFILE
IR_IOR=$INSTANCE_DIR/$ACS_IR_IORFILE

#determine the TCP ports to be used
NAMING_SERVICE_PORT=`getNamingServicePort`
NOTIFY_SERVICE_PORT=`getNotifyServicePort`
LOGGING_NOTIFY_SERVICE_PORT=`getLoggingNotifyServicePort`
ARCHIVE_NOTIFY_SERVICE_PORT=`getArchiveNotifyServicePort`
LOGGING_SERVICE_PORT=`getLoggingServicePort`
IR_PORT=`getIRPort`
LOG_SERVICE_PORT=`getLogPort`
CDB_PORT=`getCDBPort`

# Always use -ORBDottedDecimalAddresses=1
ORBOPTS="-ORBDottedDecimalAddresses 1"

#-------------------------------------------------------------------------
#a sanity check to ensure user does not run acsStartORBSRVC twice in a row
#using the same baseport
if [ -e $NAMING_SERVICE_PIDFILE ]
then
    ACS_LOG_ERROR "It appears as if you're trying to run the `basename $0` command twice"
    ACS_LOG_ERROR "    in a row using the same ACS_INSTANCE ($ACS_INSTANCE). This is not possible."
    exit $EC_FAILURE
else
    mkdir -p $INSTANCE_DIR/$ACS_PID_DIR
    mkdir -p $INSTANCE_DIR/$ACS_OUT_DIR
    mkdir -p $INSTANCE_DIR/$ACS_IOR_DIR
fi

#
# Makes sure that the directory for temporary 
# ACS_INSTANCE files exists.
#
if ! createInstanceDirectory $ACS_INSTANCE
then
     ACS_LOG_ERROR "Cannot create $INSTANCE_DIR"
     exit $EC_CANNOTCREATE
fi

#ensure the port numbers are actually free
if ! checkTCPPort $NAMING_SERVICE_PORT
then
    ACS_LOG_ERROR "Naming service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $NOTIFY_SERVICE_PORT
then
    ACS_LOG_ERROR "Notify service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $LOGGING_NOTIFY_SERVICE_PORT
then
    ACS_LOG_ERROR "Logging notify service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $ARCHIVE_NOTIFY_SERVICE_PORT
then
    ACS_LOG_ERROR "Archive notify service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $LOGGING_SERVICE_PORT
then
    ACS_LOG_ERROR "Logging service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $IR_PORT
then
    ACS_LOG_ERROR "Interface repository port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $LOG_SERVICE_PORT
then
    ACS_LOG_ERROR "Log service port is being used by another process. Cannot continue!"
    exit $EC_NOPORT

elif ! checkTCPPort $CDB_PORT
then
    ACS_LOG_ERROR "CDB port is being used by another process. Cannot continue!"
    exit $EC_NOPORT
fi


################################
#Abnormal termination function
################################
function timeoutExit
{
    if [ "X" != "X$NAMING_SERVICE_PID" ]
    then
	acsKillProc $NAMING_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the naming service"
    fi 

    if [ "X" != "X$NOTIFY_SERVICE_PID" ]
    then
	acsKillProc $NOTIFY_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the notification service"
    fi 

    if [ "X" != "X$LOGGING_NOTIFY_SERVICE_PID" ]
    then
	acsKillProc $LOGGING_NOTIFY_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the logging notification service"
    fi 

    if [ "X" != "X$ARCHIVE_NOTIFY_SERVICE_PID" ]
    then
	acsKillProc $ARCHIVE_NOTIFY_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the archive notification service"
    fi 

    if [ "X" != "X$LOGGING_SERVICE_PID" ]
    then
	acsKillProc $LOGGING_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the ACS logging service"
    fi 

    if [ "X" != "X$IRFEED_PID" ]
    then
	acsKillProc $IRFEED_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the interface repository"
    fi 

    if [ "X" != "X$IR_PID" ]
    then
	acsKillProc $IR_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the interface repository"
    fi 

    if [ "X" != "X$LOG_SERVICE_PID" ]
    then
	acsKillProc $LOG_SERVICE_PID 2> /dev/null || ACS_LOG_ERROR "Cannot kill the ACS log service"
    fi 

    if [ "X" != "X$CDB_PORT" ]
    then
	cdbjDALShutdown -k corbaloc::$HOST:$CDB_PORT/CDB &> /dev/null || ACS_LOG_ERROR "Cannot kill the CDB"
    fi

    rm -rf $INSTANCE_DIR || ACS_LOG_ERROR "Cannot delete $INSTANCE_DIR"
    exit $EC_TIMEOUT
}

ACS_LOG_INFO "Starting CORBA Services"
ACS_LOG_INFO "    Orb options:  $ORBOPTS"

################################
# Interface Repository
################################
# The IOR is saved in $IR_IOR
#
# Note: this is started first, so that we can do the IFR loading (which depends on IR being started)
#       immediately afterwards. IFR loading is a long-running process, so we want to start it ASAP.
#
ACS_LOG_INFO "Starting Interface Repository"

# This is TAO Interface Repository
# $ACE_ROOT/TAO/orbsvcs/IFR_Service/IFR_Service -ORBEndpoint iiop://$HOST:$IR_PORT  -o $IR_IOR $ORBOPTS &

#This is MICO Interface Repository
LD_LIBRARY_PATH=$MICO_HOME/lib:$LD_LIBRARY_PATH
$MICO_HOME/bin/ird -ORBNoResolve -ORBIIOPAddr inet:$HOST:$IR_PORT --ior $IR_IOR &

IR_PID=$!
echo $IR_PID > $IR_PIDFILE


#block until the IOR shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $IR_IOR -b "IOR:"
then
    ACS_LOG_ERROR "Unable to start the Interface Repository!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

# Now that the Interface Repository is running, 
# it is safe to load the Interface Repository.
#
# Loading ACS IDL Interfaces in Interface Repository, as a background job, so processing can continue in parallel.

acsstartupLoadIFR & #this C++ based script is a couple of seconds faster than acsIrFeed.
#acsIrfeed  -IRcorbaloc corbaloc::$HOST:$ACS_IR_PORT/InterfaceRepository &
IRFEED_PID=$!
echo $IRFEED_PID > $IRFEED_PIDFILE

################################
# Naming Service
################################
ACS_LOG_INFO "Starting Naming Service"
$ACE_ROOT/TAO/orbsvcs/Naming_Service/Naming_Service -ORBEndpoint iiop://$HOST:$NAMING_SERVICE_PORT -o $NAME_IOR $ORBOPTS &

NAMING_SERVICE_PID=$!
echo $NAMING_SERVICE_PID  > $NAMING_SERVICE_PIDFILE

#block until the IOR shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $NAME_IOR -b "IOR:"
then
    ACS_LOG_ERROR "Unable to start the Naming Service!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

######################################
#   ACS Configuration Database
#   No recovery is attempted
#
#   Note: this is started immediately after the naming service 
#         (which is its only dependency) in the background, 
#         for performance reasons. The code which
#         checks to make sure cdbjDAL has started properly
#         has been moved to the end of this file to improve
#         performance.
#######################################

ACS_LOG_INFO "Starting ACS Configuration Database"
ACS_LOG_INFO "    CDB data is in:  $ACS_CDB"
cdbjDAL -OAport $CDB_PORT -n 2>&1 | tee $CDB_OUT &
#copy tee's PID
echo $! >> $INSTANCE_DIR/$ACS_PIDSFILE

# Now that the Naming Service and Interface Repository are both running, 
# the Interface Repository is added to the Name Service
# using the temporary file, that is afterwards deleted.
$ACE_ROOT/TAO/utils/nslist/nsadd --name InterfaceRepository --ior `cat $IR_IOR` -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService $ORBOPTS &

#------------------------------------------------------------------------------------------
################################
# Notify Service
################################
# Note - this must be started after the naming service is running.

ACS_LOG_INFO "Starting Notify Service"

# I need to cd to $ACE_ROOT/TAO/orbsvcs/Notify_Service
# in order to get the correct svc.conf service configuration file.
STARTUP_DIR=$PWD
cd $ACE_ROOT/TAO/orbsvcs/Notify_Service
$ACE_ROOT/TAO/orbsvcs/Notify_Service/Notify_Service -ORBEndpoint iiop://$HOST:$NOTIFY_SERVICE_PORT -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService -IORoutput $NOTIFY_IOR $ORBOPTS -Boot &> $NOTIFY_OUT &
cd $STARTUP_DIR

NOTIFY_SERVICE_PID=$!
echo $NOTIFY_SERVICE_PID  > $NOTIFY_SERVICE_PIDFILE

#block until the IOR shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $NOTIFY_IOR -b "IOR:"
then
    ACS_LOG_ERROR "The IOR of the notify service was never emitted!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

#------------------------------------------------------------------------------------------
################################
# Logging Notify Service
################################
# Note - this must be started after the naming service is running.

ACS_LOG_INFO "Starting Logging Notify Service"

# I need to cd to $ACE_ROOT/TAO/orbsvcs/Notify_Service
# in order to get the correct svc.conf service configuration file.
STARTUP_DIR=$PWD
cd $ACE_ROOT/TAO/orbsvcs/Notify_Service
$ACE_ROOT/TAO/orbsvcs/Notify_Service/Notify_Service -ORBEndpoint iiop://$HOST:$LOGGING_NOTIFY_SERVICE_PORT -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService -IORoutput $LOGGING_NOTIFY_IOR $ORBOPTS -Factory LoggingNotifyEventChannelFactory -Boot &> $LOG_NOTIFY_OUT &
cd $STARTUP_DIR

LOGGING_NOTIFY_SERVICE_PID=$!
echo $LOGGING_NOTIFY_SERVICE_PID  > $LOGGING_NOTIFY_SERVICE_PIDFILE

#block until the IOR shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $LOGGING_NOTIFY_IOR -b "IOR:"
then
    ACS_LOG_ERROR "The IOR of the logging notify service was never emitted!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

# Create the logging channel now.
acsstartupCreateChannel --name_service corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService --notify_service_id LoggingNotifyEventChannelFactory --channel_id LoggingChannel #--max_queue_length 10 --reject_new_events true #--max_events_per_consumer 5 #--discard_policy FifoOrder #

#------------------------------------------------------------------------------------------
################################
# Archive Notify Service
################################
# Note - this must be started after the naming service is running.

ACS_LOG_INFO "Starting Archive Notify Service"

# I need to cd to $ACE_ROOT/TAO/orbsvcs/Notify_Service
# in order to get the correct svc.conf service configuration file.
STARTUP_DIR=$PWD
cd $ACE_ROOT/TAO/orbsvcs/Notify_Service
$ACE_ROOT/TAO/orbsvcs/Notify_Service/Notify_Service -ORBEndpoint iiop://$HOST:$ARCHIVE_NOTIFY_SERVICE_PORT -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService -IORoutput $ARCHIVE_NOTIFY_IOR $ORBOPTS -Factory ArchiveNotifyEventChannelFactory -Channel -ChannelName ArchivingChannel -Boot &> $ARCHIVE_NOTIFY_OUT &
cd $STARTUP_DIR

ARCHIVE_NOTIFY_SERVICE_PID=$!
echo $ARCHIVE_NOTIFY_SERVICE_PID  > $ARCHIVE_NOTIFY_SERVICE_PIDFILE

#block until the IOR shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $ARCHIVE_NOTIFY_IOR -b "IOR:"
then
    ACS_LOG_ERROR "The IOR of the archive notify service was never emitted!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

################################
# Logging Service
################################
# NOTE - this must be started after the Notify Service (and Naming Service) are running.

ACS_LOG_INFO "Starting Logging Service"

loggingService  -ORBEndpoint iiop://$HOST:$LOGGING_SERVICE_PORT -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService -ORBInitRef LoggingNotifyEventChannelFactory=corbaloc::$HOST:$LOGGING_NOTIFY_SERVICE_PORT/LoggingNotifyEventChannelFactory $ORBOPTS &> $LOGGING_OUT &

LOGGING_SERVICE_PID=$!
echo $LOGGING_SERVICE_PID > $LOGGING_SERVICE_PIDFILE

#block until the expected output shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $LOGGING_OUT -b "ACS Centralized Logger is running"
then
    ACS_LOG_ERROR "Unable to start the Logging Service!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

######################################
#   ACS Log  service
#######################################
# NOTE - this must be started after the Loggging Service is running.

ACS_LOG_INFO "Starting ACS Log service"
acsLogSvc -silent -ORBEndpoint iiop://$HOST:$LOG_SERVICE_PORT -ORBInitRef NameService=corbaloc::$HOST:$NAMING_SERVICE_PORT/NameService $ORBOPTS &> $LOG_SERVICE_OUT &

LOG_SERVICE_PID=$!
echo $LOG_SERVICE_PID > $LOG_SERVICE_PIDFILE

########################################
# Make sure the CDB, which was started at the beginning of 
# this script, was successfully started.
########################################
#
# Check to see that the DAL actually got started (w/in the timeout). 
# if not, clean up and exit.


#block until the expected output shows up in the the correct file
if ! acsutilBlock -t $MAX_TIMEOUT -f $CDB_OUT -b "JDAL is ready and waiting"
then
    ACS_LOG_ERROR "Unable to start the ACS CDB!"
    ACS_LOG_ERROR "Try increasing the value of \$ACS_STARTUP_TIMEOUT_MULTIPLIER"
    timeoutExit
fi

ACS_LOG_FORCED "INFO - For this ACS session, please do an 'export ACS_INSTANCE=$ACS_INSTANCE' on all terminals running ACS clients."
ACS_LOG_FORCED "INFO - The acsStartORBSRVC script has now completed!"

#
# ___oOo___
